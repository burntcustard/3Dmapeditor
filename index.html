<table>
<tr>
<td>

<div id=viewport>
  <div id=camera>
    <div id=scene>
    
      <div id=floor></div>
      <div id=grid></div>
      <div id=cursor></div>
    
    </div>
  </div>
</div>

<p>Layer: <input id=Z type=number value=0 min=0 max=30 size=2>

<td>
Scene size:
W <input type=number value=10 id=W size=2 min=1 max=100> H <input type=number value=10 id=H size=2 min=1 max=100>
<p>
piece:
<button onclick="piece=2;preview()">cube</button>
<button onclick="piece=3;preview()">slope</button>
<button onclick="piece=4;preview()">45° wall</button>
<button onclick="piece=5;preview()">corner 1</button>
<button onclick="piece=6;preview()">corner 2</button>
<!--button onclick="piece=7;preview()">corner 3</button-->
<p>
Texture:
<button onclick="texture=0;preview()" selected>grass</button>
<button onclick="texture=1;preview()" selected>sand</button>
<button onclick="texture=2;preview()" selected>rock</button>
<button onclick="texture=3;preview()" selected>ice</button>
<p>
Rotation:
<button onclick="rotation=0;preview()">0</button>
<button onclick="rotation=1;preview()">90°</button>
<button onclick="rotation=2;preview()">180°</button>
<button onclick="rotation=3;preview()">270°</button>
<p>
Others 
<button onclick="preview(token='')">water cube</button>
<button onclick="preview(token='')">tree</button>
<button onclick="preview(token='')">fence</button>
<button onclick="preview(token='#')">nothing</button>

<p>Preview
<br>
<div id=viewport2>
  <div id=camera2>
    <div id=scene2>
    
    </div>
  </div>
</div>

<p>
Map
<br>
<br>
<textarea id=out readonly spellcheck=false></textarea>
</table>
<style>
/* UI */
td{vertical-align:top;font-family:arial;padding:0 20px 0 0}
textarea{width:340px;height:220px;line-height:12px;font-size:16px;letter-spacing:3px}

/* 3D scene */
#viewport{width:700px;height:600px;overflow:hidden;border:1px solid;position:relative;perspective:500px}
#viewport2{width:100px;height:100px;overflow:hidden;border:1px solid;position:relative;perspective:500px}
#viewport *{transform-style:preserve-3d;box-sizing:border-box}
#viewport2 *{transform-style:preserve-3d;box-sizing:border-box}
#camera{width:0;height:0;position:absolute;top:50%;left:50%}
#camera2{width:0;height:0;position:absolute;top:100%;left:50%}
#scene{position:fixed;width:2020px;height:2020px;transform:translate3D(-50%,-50%,-2000px)rotateX(45deg)}
#scene2{position:fixed;width:200px;height:200px;transform:translate3D(-50%,-50%,-2000px)rotateX(45deg)}
#grid{position:fixed;width:2020px;height:2020px;background:linear-gradient(#777 20px,#0000 20px),linear-gradient(90deg,#777 20px,#0000 20px);background-size:200px 200px;font:200px arial;color:#aaa;transform:translateZ(1px)}
#floor{position:fixed;width:2020px;height:2020px;background:#5b5}
#cursor .face{border:10px solid #0008}

/* A piece is either a cube, a slope, a plane or a sprite */
/* Cubes and slopes have 4 color varieties: v1 to v4 */
/* Sprites are planes that always face the camera */

/* common to all pieces and faces */
.piece{pointer-events:none;position:absolute;width:200px;height:200px}
.face{width:200px;height:200px;position:fixed;border:10px solid #000}
.scene .face{backface-visibility:hidden}

/* piece rotation */
.r1{transform:rotateZ(90deg)}
.r2{transform:rotateZ(180deg)}
.r3{transform:rotateZ(-90deg)}

/* common to all piece faces */
.up{transform:translateZ(200px)}
.left{transform:rotateY(-90deg)translate3D(100px,0,100px)}
.right{transform:rotateY(90deg)translate3D(-100px,0,100px)}
.front{transform:rotateX(-90deg)translate3D(0,-100px,100px)}
.back{transform:rotateX(90deg)translate3D(0,100px,100px)}
//.down{transform:rotateX(180deg)}

/* specific to slope */
.s3 .up{height:282px;transform:translate3D(0,-41px,100px)rotateX(-45deg)}
.s3 .left{clip-path:path('M200 0L0 200L0 0Z')}
.s3 .right{clip-path:path('M0 0L200 200L200 0Z')}

/* Specific to 45° wall */
.s4 .front{transform: rotateX(-90deg)translate3D(-42px,-100px,0)rotateY(45deg);width:282px}
.s4 .up{clip-path:path('M200 0L0 200L0 0Z')}

/* Specific to corner1 (flat) */
.s5 .left{clip-path:path('M200 0L0 200L0 0Z')}
.s5 .back{clip-path:path('M200 0L0 0L0 200Z')}
.s5 .up{transform: rotateX(-90deg)translate3D(-92px,-100px,-72px)rotateY(45deg)rotateX(35deg);width:282px;height:245px;clip-path:path('M0 245L141 0L282 245Z')}

/* Specific to corner2 (angle) */
.s6 .left{clip-path:path('M200 0L0 200L0 0Z')}
.s6 .back{clip-path:path('M200 0L0 0L0 200Z')}
.s6 .up{height:282px;clip-path:path('M0 0L200 282L0 282Z');transform:rotateX(-90deg)translate3D(0px,-100px,-40px)rotateX(45deg)}
.s6 .right{width:282px;clip-path:path('M0 0L282 200L282 0Z');height:200px;transform: rotateY(90deg)translate3D(-100px,0px,-42px)rotateY(-45deg)}

/* textures */
.t0 *{background:#393}
.t0 .up{background:#5b5}
#cursor .t0 *{background:#5b58}
.t1 *{background:#fd6}
.t1 .up{background:#fe8}
#cursor .t1 *{background:#fe88}
.t2 *{background:#bbb}
.t2 .up{background:#ddd}
#cursor .t2 *{background:#ddd8}
.t3 *{background:#77f8}
.t3 .up{background:#ddf8}
#cursor .t3 *{background:#ddf4}

/* plane, sprite */
.plane,.sprite{font-size:200px}
.plane *,.sprite *{transform-origin:50% 100%;transform:translateY(-100px)rotateX(-90deg)}

/* Extra shapes */
.s0 * {background: none}

/* Water cube */
.e1 *, .e1 .up {background:#77f8}

/* Tree */
.e2, .e3{font-size:200px}
.e2 *,.e3 *{transform-origin:50% 100%}

/* Fence */
.e3{font-size:160px}
.e3 div{transform:translateY(-100px)rotateX(-90deg)}
</style>

<script>
// pieces encoding (ASCII)
// =======================

// Chars 0-32: various pieces

//     0000000: \0  reserved
//     0000001: �   water
//     0000010: �   tree
//     0000011: �   fence
//     ...
//     0010000: (space) nothing
//
// Chars 33-127: 0b0xxxyyzz
//
// - zz (bits 0-1): rotation
//     0°
//     90°
//     180°
//     270°
//
//  - yy (bits 2-3): texture (pick 4)
//     sand
//     grass
//     rock
//     ice
//     brick
//     wood
//     ...
//
//  - xxx (bits 4-6): piece
//     000-001 reserved (chars 0-31)
//     010 cube
//     011 slope
//     100 45° wall
//     101 slope corner flat
//     110 slope corner angled
//     111 reverse corner


// Globals
rotation = 0;
texture = 0;
piece = 2;
token = " ";
w = 10;
h = 10;
x = y = z = 0;
map = [Array(w*h).fill('#')];

// Firefox detection
fx = navigator.userAgent.includes("Firefox");

W.onchange = W.onupdate = W.oninput = () => { w = +W.value; updateMap(); map[0] = Array(w*h).fill('#'); }
W.onchange = H.onupdate = H.oninput = () => { h = +H.value; updateMap(); map[0] = Array(w*h).fill('#'); }

// Update map
updateMap = () => {
  out.innerHTML = "";
  for(i in map){
    out.innerHTML += "Layer " + i + ":\n\n";
    out.innerHTML += map[i].join("").match(new RegExp(".{"+w+"}","g")).join("\n");
    out.innerHTML += "\n\n";
  }
  scene.style.width = floor.style.width = grid.style.width = w * 200 + 20 + "px";
  scene.style.height = floor.style.height = grid.style.height = h * 200 + 20 + "px";
  moveScene(rx, rz);
}

// Move the scene
moveScene = (rx, rz) => {
  scene.style.transformOrigin = `50% 50% ${z*200}px`;
  scene.style.transform = `translate3D(-50%,-50%,-${Math.max(w*200,h*200)+z*200}px)rotateX(${rx}deg)rotateZ(${rz}deg)`;
  scene2.style.transform = `translate3D(-50%,-50%,-2000px)rotateX(${rx}deg)rotateZ(${rz}deg)`;
}

// Mouse globals
mousedown = 0;
rx = 45;
rz = 0;
mousex = 0;
mousey = 0;

// Mouse down/up: handle right button
onmousedown = onmouseup = e => {
  if(e.which == 3){
    mousedown ^= 1;
    mousex = e.pageX;
    mousey = e.pageY;
    //console.log(mousex, mousey);
    e.preventDefault();
    e.stopPropagation();
    return false; 
  }
}

// Right click: prevent context menu from appearing
oncontextmenu = e => {
  e.preventDefault();
  e.stopPropagation();
  return false;
}

// Mouse move: update camera if right button is pressed
viewport.onmousemove = e => {
 if(mousedown){
  rz += (e.pageX - mousex) / 5;
  rx += (e.pageY - mousey) / 5;
  if(rx > 88) rx = 88;
  if(rx < 0) rx = 0;
  
  mousex = e.pageX;
  mousey = e.pageY;
  
  //console.log(rz, rx);
  
  moveScene(rx, rz);
  updateSprites();
 }
}

// Left click: add item in the scene
scene.onclick = e => {
  x = (~~((fx ? e.layerX : e.offsetX) / 200));
  y = (~~((fx ? e.layerY : e.offsetY) / 200));
  if(x >= 0 && x < w && y >= 0 && y < h){
    old = document.querySelector(`#scene [x='${x}'][y='${y}'][z='${z}']`);
    console.log(old);
    if(old){
      old.remove();
    }
    scene.insertAdjacentHTML("beforeEnd", drawpiece(x, y, z));
    console.log(rotation, texture, piece, token);
    map[z][y*w+x] = token;
    updateMap()
    updateSprites();
  }
  W.disabled = true;
  H.disabled = true;
}

scene.onmousemove = e => {
  x = (~~((fx ? e.layerX : e.offsetX) / 200));
  y = (~~((fx ? e.layerY : e.offsetY) / 200));
  if(x >= 0 && x < w && y >= 0 && y < h){
    cursor.innerHTML = drawpiece(x, y, z, 1);
    updateMap();
    updateSprites();
  }
}

scene.onmouseout = e => {
  cursor.innerHTML = "";
}

// Preview current token
preview = (t) => {
  if(t){
    token = t;
    piece = 0;
    rotation = 0;
    texture = 0;
    extrapiece = token.codePointAt();
  }
  else {
    token = String.fromCharCode(rotation + (texture << 2) + (piece << 4));
    console.log(rotation, texture, piece, token);
    extrapiece = 0;
  }
  scene2.innerHTML = drawpiece(0,0,0);
  updateSprites();
}

// Return HTML code for current piece, at the given coordinates
drawpiece = (x, y, z, cursor) => {
  
  // pieces: 2: cube, 3: slope, 4: 45° wall, 5: slope corner flat, 6: slope corner angled, 7: reverse corner flat
  // extra pieces: 1: water cube, 2: tree, 3: fence
  
  html = `<div class="piece s${piece} r${rotation} t${texture} e${extrapiece}" ${cursor || `x=${x} y=${y} z=${z}`} style='transform:translate3d(${x*200}px,${y*200}px,${z*200}px)rotateZ(${rotation*90}deg)'>`;

  if(piece || extrapiece == 1){
    html += `<div class="face up"></div>`;
    html += `<div class="face left"></div>`;
    if(piece != 4 && piece != 5) html += `<div class="face right"></div>`;
    if(piece != 3 && piece != 5 && piece != 6) html += `<div class="face front"></div>`;
    html += `<div class="face back"></div>`;
  }
  
  else {
    if(extrapiece == "2"){
      html += `<div>🌳`;
    }
    else if(extrapiece == "3"){
      html += `<div>🚧`;
    }
  }
  return html;
}

// Make all sprites face the camera
updateSprites = () => {
  sprites = document.querySelectorAll(".e2 div");
  for(sprite of sprites){
    sprite.style.transform = `translateY(-100px)rotateZ(${-rz}deg)rotateX(${-rx}deg)`;
  }
}

// Change grid height
Z.onchange = Z.onupdate = Z.oninput = e => {
  z = Z.value;
  if(!map[z]){
    map[z] = Array(w*h).fill('#');
  }
  grid.style.transform = `translateZ(${z*200+1}px)`;
  updateMap();
}

updateMap();
preview();
 
</script>